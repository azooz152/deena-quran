<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ù…Ø¹Ù„Ù… - Ø¯ÙŠÙ†Ø§</title>
    <style>
        /* --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: #1a1a1a;
            user-select: none; /* Ù…Ù†Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ */
        }

        /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© */
        .bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url('assets/bg-main.png') no-repeat center center;
            background-size: cover;
            z-index: 1;
        }

        /* --- Ø§Ù„Ø´Ø§Ø´Ø© 1: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ± (Menu) --- */
        #menuSection {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.6); /* ØªØ¹ØªÙŠÙ… Ø®ÙÙŠÙ Ù„Ù„Ø®Ù„ÙÙŠØ© */
            transition: transform 0.5s ease;
        }

        .menu-title {
            color: #FFCA28; font-size: 3rem; font-weight: bold; margin-bottom: 40px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .surah-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
            width: 80%; max-width: 800px;
        }

        .surah-btn {
            background: white; border: 4px solid #4DB6AC; border-radius: 20px;
            padding: 20px; font-size: 1.8rem; font-weight: bold; color: #00695C;
            cursor: pointer; transition: transform 0.2s, background 0.3s;
            text-align: center; box-shadow: 0 5px 0 #004D40;
        }

        .surah-btn:active {
            transform: scale(0.95) translateY(5px);
            box-shadow: 0 0 0 transparent;
        }

        /* --- Ø§Ù„Ø´Ø§Ø´Ø© 2: Ø§Ù„Ù…Ø´ØºÙ„ (Player) --- */
        #playerSection {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; /* Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹ ØªØ­Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
            display: none; /* Ù…Ø®ÙÙŠ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        }

        /* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© */
        .back-btn {
            position: absolute; top: 30px; left: 30px;
            padding: 10px 30px; background: #FF7043;
            border: 3px solid white; border-radius: 50px;
            color: white; font-size: 1.2rem; font-weight: bold; 
            cursor: pointer; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¢ÙŠØ© */
        .ayah-box {
            position: relative; margin: 100px auto 0;
            width: 80%; background: #fff;
            border: 6px solid #FFCA28; border-radius: 30px;
            padding: 20px; text-align: center;
            box-shadow: 0 8px 0 #F57F17; z-index: 50;
        }

        #ayahText { color: #37474F; font-size: 2.5rem; font-weight: bold; }

        /* Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ§Ù„ÙÙ… */
        .character-zone {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 75%;
            display: flex; justify-content: center; align-items: flex-end;
            pointer-events: none; z-index: 30;
        }

        .dina-wrapper { position: relative; height: 100%; }
        #dinaImg { height: 100%; display: block; }
        
        #mouth {
            position: absolute;
            top: 55.5%; left: 41.5%; transform: translate(-50%, -50%);
            width: 19%; 
        }

    </style>
</head>
<body>

    <div class="bg-layer"></div>

    <div id="menuSection">
        <div class="menu-title">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø© ÙŠØ§ Ø¨Ø·Ù„</div>
        <div class="surah-grid">
            <button class="surah-btn" onclick="openSurah('001', 'Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø©')">Ø§Ù„ÙØ§ØªØ­Ø©</button>
            <button class="surah-btn" onclick="openSurah('112', 'Ø³ÙˆØ±Ø© Ø§Ù„Ø¥Ø®Ù„Ø§Øµ')">Ø§Ù„Ø¥Ø®Ù„Ø§Øµ</button>
            <button class="surah-btn" onclick="openSurah('113', 'Ø³ÙˆØ±Ø© Ø§Ù„ÙÙ„Ù‚')">Ø§Ù„ÙÙ„Ù‚</button>
            <button class="surah-btn" onclick="openSurah('114', 'Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ø§Ø³')">Ø§Ù„Ù†Ø§Ø³</button>
            <button class="surah-btn" onclick="openSurah('108', 'Ø³ÙˆØ±Ø© Ø§Ù„ÙƒÙˆØ«Ø±')">Ø§Ù„ÙƒÙˆØ«Ø±</button>
            <button class="surah-btn" onclick="openSurah('110', 'Ø³ÙˆØ±Ø© Ø§Ù„Ù†ØµØ±')">Ø§Ù„Ù†ØµØ±</button>
        </div>
    </div>

    <div id="playerSection">
        <button class="back-btn" onclick="goBackToMenu()">ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        
        <div class="ayah-box">
            <div id="ayahText">...</div>
        </div>
        
        <div class="character-zone">
            <div class="dina-wrapper">
                <img src="assets/images/girl.png" id="dinaImg">
                <img src="assets/images/mouth_closed.png" id="mouth">
            </div>
        </div>
    </div>

    <audio id="audioPlayer" crossorigin="anonymous"></audio>

<script>
    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    const menuSec = document.getElementById('menuSection');
    const playerSec = document.getElementById('playerSection');
    const audio = document.getElementById('audioPlayer');
    const textDisp = document.getElementById('ayahText');
    const mouthImg = document.getElementById('mouth');

    let audioCtx, analyser, dataArray;
    let isInitialized = false;

    // --- Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙˆØ±Ø© ---
    function openSurah(id, name) {
        // 1. ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª
        menuSec.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        playerSec.style.display = 'block'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø´ØºÙ„

        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…
        textDisp.innerText = name;

        // 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙˆØª (Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ù…Ø¹Ù„Ù…)
        // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ 001.mp3
        const formattedId = id.toString().padStart(3, '0');
        audio.src = `https://server10.mp3quran.net/minsh/al_mus7af_al_mo3lim/${formattedId}.mp3`;

        // 4. ØªÙ‡ÙŠØ¦Ø© Ù…Ø­Ù„Ù„ Ø§Ù„ØµÙˆØª (AudioContext)
        // ** Ø§Ù„Ø³Ø± Ù‡Ù†Ø§ **: Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ³Ù…Ø­ Ø¨Ù‡Ø°Ø§ Ù„Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‚Ø± Ù„Ù„ØªÙˆ Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø³ÙˆØ±Ø©
        if (!isInitialized) {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                analyser = audioCtx.createAnalyser();
                const source = audioCtx.createMediaElementSource(audio);
                source.connect(analyser);
                analyser.connect(audioCtx.destination);
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isInitialized = true;
            } catch(e) {
                console.log("Audio Context Error: " + e);
            }
        }

        // ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ø§Ù„Ù€ Context Ù…Ø¹Ù„Ù‚Ø§Ù‹
        if (audioCtx && audioCtx.state === 'suspended') {
            audioCtx.resume();
        }

        // 5. ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙˆØ­Ø±ÙƒØ© Ø§Ù„ÙÙ… ÙÙˆØ±Ø§Ù‹
        audio.play().then(() => {
            animateMouth();
        }).catch(err => {
            console.error(err);
            textDisp.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        });
    }

    // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© ---
    function goBackToMenu() {
        audio.pause(); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª
        audio.currentTime = 0; // Ø¥Ø¹Ø§Ø¯Ø© Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©
        mouthImg.src = 'assets/images/mouth_closed.png'; // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙÙ…
        
        playerSec.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø´ØºÙ„
        menuSec.style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    }

    // --- ÙˆØ¸ÙŠÙØ© ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙÙ… (Lip Sync) ---
    function animateMouth() {
        if (!audio.paused && !audio.ended && analyser) {
            requestAnimationFrame(animateMouth);
            analyser.getByteFrequencyData(dataArray);
            
            let sum = 0;
            for(let i = 0; i < dataArray.length; i++) sum += dataArray[i];
            let vol = sum / dataArray.length;

            // Ø­Ø³Ø§Ø³ÙŠØ© Ø­Ø±ÙƒØ© Ø§Ù„ÙÙ…
            if (vol > 20) mouthImg.src = 'assets/images/mouth_open.png';
            else if (vol > 8) mouthImg.src = 'assets/images/mouth_half.png';
            else mouthImg.src = 'assets/images/mouth_closed.png';
        } else {
            mouthImg.src = 'assets/images/mouth_closed.png';
        }
    }
</script>
</body>
</html>
