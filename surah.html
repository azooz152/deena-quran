<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ÙŠÙ†Ø§ - Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ù…Ø¹Ù„Ù…</title>
    <style>
        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; font-family: Tahoma, sans-serif;
            background-color: #1a1a1a;
        }

        /* ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© */
        .bg-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url('assets/bg-main.png') no-repeat center center;
            background-size: cover;
            z-index: 1; /* Ø·Ø¨Ù‚Ø© Ø®Ù„ÙÙŠØ© */
        }

        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center;
            z-index: 10; /* Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
        }

        /* Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© */
        .back-btn {
            position: absolute; top: 30px; left: 30px;
            padding: 15px 40px; background: #FF7043;
            border: 4px solid white; border-radius: 50px;
            color: white; font-size: 1.5rem; font-weight: bold; 
            cursor: pointer; z-index: 100;
        }

        /* Ø¥Ø·Ø§Ø± Ø§Ù„Ø¢ÙŠØ© */
        .ayah-box {
            position: relative; margin-top: 100px;
            width: 80%; background: #fff;
            border: 6px solid #FFCA28; border-radius: 30px;
            padding: 20px; text-align: center;
            box-shadow: 0 10px 0 #F57F17;
        }

        #ayahText { 
            color: #37474F; font-size: 2.5rem; font-weight: bold; 
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© */
        .character-zone {
            position: absolute; bottom: 0; left: 0;
            width: 100%; height: 70%;
            display: flex; justify-content: center; align-items: flex-end;
            pointer-events: none;
        }

        .dina-wrapper { 
            position: relative; height: 100%; width: auto; 
        }
        
        #dinaImg { height: 100%; display: block; }

        /* ØªØ¹Ø¯ÙŠÙ„ Ù…ÙƒØ§Ù† Ø§Ù„ÙÙ… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØµÙˆØ±ØªÙƒ */
        #mouth {
            position: absolute;
            top: 56%;  /* Ù†Ø²Ù„Øª Ø§Ù„ÙÙ… Ù„Ù„Ø£Ø³ÙÙ„ */
            left: 41.5%; 
            transform: translate(-50%, -50%);
            width: 19%; 
            z-index: 20;
        }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø¡ (Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ©) --- */
        #overlay-screen {
            position: fixed !important; /* ÙØ±Ø¶ Ø§Ù„ØªØ«Ø¨ÙŠØª */
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9); /* Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ Ø´Ø¨Ù‡ Ù…Ø¹ØªÙ…Ø© */
            z-index: 99999 !important; /* Ø£Ø¹Ù„Ù‰ Ø·Ø¨Ù‚Ø© Ù…Ù…ÙƒÙ†Ø© */
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            cursor: pointer;
        }

        .play-btn {
            width: 150px; height: 150px;
            background: #4CAF50;
            border: 8px solid #fff;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 50px #4CAF50;
        }

        .play-triangle {
            width: 0; height: 0;
            border-top: 30px solid transparent;
            border-bottom: 30px solid transparent;
            border-right: 60px solid white; /* Ù…Ø«Ù„Ø« Ù…ØªØ¬Ù‡ Ù„Ù„ÙŠØ³Ø§Ø± */
            margin-left: -15px;
        }

        .hint-text {
            color: white; font-size: 2rem; margin-top: 30px; font-weight: bold;
        }

    </style>
</head>
<body>

    <div class="bg-layer"></div>

    <div id="overlay-screen" onclick="startExperience()">
        <div class="play-btn">
            <div class="play-triangle"></div>
        </div>
        <div class="hint-text">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„ØªØ´ØºÙŠÙ„</div>
    </div>

    <div class="container">
        <button class="back-btn" onclick="history.back()">ğŸ  Ø®Ø±ÙˆØ¬</button>
        
        <div class="ayah-box">
            <div id="ayahText">...</div>
        </div>
        
        <div class="character-zone">
            <div class="dina-wrapper">
                <img src="assets/images/girl.png" id="dinaImg">
                <img src="assets/images/mouth_closed.png" id="mouth">
            </div>
        </div>
    </div>

    <audio id="audioPlayer" crossorigin="anonymous"></audio>

<script>
    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
    const audio = document.getElementById('audioPlayer');
    const mouthImg = document.getElementById('mouth');
    const textDisp = document.getElementById('ayahText');
    const overlay = document.getElementById('overlay-screen');

    // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const sNum = localStorage.getItem('surah_num') || "001";
    const sName = localStorage.getItem('surah_name') || "Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø©";
    const surahID = sNum.toString().padStart(3, '0');

    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ù†Øµ ÙÙˆØ±Ø§Ù‹
    textDisp.innerText = sName;
    // Ø±Ø§Ø¨Ø· Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹
    audio.src = `https://server10.mp3quran.net/minsh/al_mus7af_al_mo3lim/${surahID}.mp3`;

    let audioCtx, analyser, dataArray;
    let isRunning = false;

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
    function startExperience() {
        if (isRunning) return;
        isRunning = true;

        // 1. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ø§Ù„ÙƒØ¨ÙŠØ±
        overlay.style.display = 'none';

        // 2. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙˆØª (Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£Ù‡Ù… Ù„Ù„Ø´Ø§Ø´Ø§Øª)
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            analyser = audioCtx.createAnalyser();
            const src = audioCtx.createMediaElementSource(audio);
            src.connect(analyser);
            analyser.connect(audioCtx.destination);
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„ØµÙˆØªÙŠ ÙŠØ¹Ù…Ù„
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        } catch (e) {
            console.log("Audio Context Error: " + e);
        }

        // 3. ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù…Ø¨Ø§Ø´Ø±Ø©
        audio.play().then(() => {
            animationLoop(); // Ø¨Ø¯Ø¡ Ø­Ø±ÙƒØ© Ø§Ù„ÙÙ…
        }).catch((err) => {
            textDisp.innerText = "ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØªØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰";
        });
    }

    // Ø­Ø±ÙƒØ© Ø§Ù„ÙÙ…
    function animationLoop() {
        requestAnimationFrame(animationLoop);
        
        if (analyser && !audio.paused) {
            analyser.getByteFrequencyData(dataArray);
            
            let sum = 0;
            for(let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            let vol = sum / dataArray.length;

            // Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„ÙÙ…
            if (vol > 25) mouthImg.src = 'assets/images/mouth_open.png';
            else if (vol > 10) mouthImg.src = 'assets/images/mouth_half.png';
            else mouthImg.src = 'assets/images/mouth_closed.png';
        } else {
            mouthImg.src = 'assets/images/mouth_closed.png';
        }
    }
</script>
</body>
</html>
