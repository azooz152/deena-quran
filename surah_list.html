<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تلاوة السورة</title>
    <style>
        body {
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Tahoma', sans-serif;
            margin: 0;
        }

        .container-glass {
            width: 90%;
            height: 90vh;
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        /* زر الرجوع */
        .back-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ff4081;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.2em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 100;
        }

        /* تنسيق الشخصية الكرتونية */
        .character-container {
            margin-top: 20px;
            position: relative;
            width: 200px;
            height: 200px;
        }

        .character-img {
            width: 100%;
            height: auto;
            border-radius: 50%;
            border: 5px solid #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* حركة الفم */
        .mouth {
            position: absolute;
            bottom: 45px; /* تحتاج ضبط حسب صورتك */
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 10px;
            background: #5a3030;
            border-radius: 50%;
            transition: height 0.1s;
        }

        /* اسم السورة */
        .surah-title {
            font-size: 3em;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin: 10px 0;
        }

        /* حاوية الآيات */
        .verses-container {
            width: 80%;
            text-align: center;
            font-size: 2em;
            color: #333;
            background: rgba(255,255,255,0.6);
            padding: 20px;
            border-radius: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .active-verse {
            color: #d32f2f;
            font-weight: bold;
            transform: scale(1.1);
            display: inline-block;
            transition: 0.3s;
        }
    </style>
</head>
<body>

    <a href="surah_list.html" class="back-btn">رجوع للقائمة</a>

    <div class="container-glass">
        
        <h1 class="surah-title" id="titleDisplay">جاري التحميل...</h1>

        <div class="character-container">
            <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" class="character-img" alt="Character">
            <div class="mouth" id="mouth"></div>
        </div>

        <div class="verses-container">
            <p id="statusText">جاري تشغيل التلاوة...</p>
        </div>

        <audio id="quranAudio" controls style="display:none;"></audio>

    </div>

    <script>
        // 1. استقبال البيانات من الرابط
        const urlParams = new URLSearchParams(window.location.search);
        const surahId = urlParams.get('id'); // مثلاً 78
        const surahName = urlParams.get('name');

        // عرض اسم السورة
        document.getElementById('titleDisplay').innerText = "سورة " + surahName;

        // 2. إصلاح رقم السورة (إضافة أصفار)
        // يحول 78 إلى 078، ويحول 1 إلى 001
        const formattedId = surahId.toString().padStart(3, '0');

        // 3. رابط الصوت (من موقع موثوق للتجربة)
        // المصحف المعلم - الحصري (مناسب للأطفال)
        const audioUrl = `https://server13.mp3quran.net/husr/Mz/${formattedId}.mp3`;

        const audioPlayer = document.getElementById('quranAudio');
        const mouth = document.getElementById('mouth');
        const statusText = document.getElementById('statusText');

        audioPlayer.src = audioUrl;

        // 4. التشغيل التلقائي عند فتح الصفحة
        window.onload = () => {
            audioPlayer.play().then(() => {
                statusText.innerText = "▶ يقرأ الآن...";
            }).catch(error => {
                statusText.innerText = "اضغط أي زر للبدء (سياسة المتصفح)";
                // بعض المتصفحات تمنع الصوت التلقائي إلا بتفاعل
                document.body.onclick = () => {
                    audioPlayer.play();
                    statusText.innerText = "▶ يقرأ الآن...";
                };
            });
        };

        // 5. محاكاة حركة الشفاه (Lip Sync Simulation)
        // نستخدم محلل صوتي بسيط لتحريك الفم بناء على قوة الصوت
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaElementSource(audioPlayer);
        
        source.connect(analyser);
        analyser.connect(audioContext.destination);
        analyser.fftSize = 256;
        
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        function animateMouth() {
            if (!audioPlayer.paused) {
                analyser.getByteFrequencyData(dataArray);
                
                // حساب متوسط قوة الصوت
                let sum = 0;
                for(let i = 0; i < bufferLength; i++) {
                    sum += dataArray[i];
                }
                let average = sum / bufferLength;

                // تحريك الفم بناء على الصوت
                // القيمة 10 هي الحد الأدنى لارتفاع الفم
                let mouthHeight = 10 + (average / 2); 
                if (mouthHeight > 40) mouthHeight = 40; // حد أقصى للفتحة

                mouth.style.height = `${mouthHeight}px`;
            } else {
                mouth.style.height = "10px"; // إغلاق الفم عند الصمت
            }
            requestAnimationFrame(animateMouth);
        }

        // تفعيل حركة الفم عند التشغيل
        audioPlayer.onplay = () => {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            animateMouth();
        };

        // عند انتهاء السورة
        audioPlayer.onended = () => {
            statusText.innerText = "صدق الله العظيم";
            mouth.style.height = "10px";
            // يمكن هنا إضافة كود للرجوع للقائمة تلقائياً بعد ثواني
            setTimeout(() => {
                window.location.href = 'surah_list.html';
            }, 3000);
        };

    </script>
</body>
</html>
